<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“è®¾ç½®å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background-color: #fafafa;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }
        button:hover { background-color: #0056b3; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            border: 1px solid #e9ecef;
            font-size: 12px;
        }
        .sql-box {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .step-number {
            width: 30px;
            height: 30px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        .step.active .step-number {
            background: #28a745;
        }
        .step.completed .step-number {
            background: #6c757d;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ æ•°æ®åº“è®¾ç½®å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©æ‚¨è®¾ç½®å’ŒéªŒè¯ Supabase æ•°æ®åº“ã€‚</p>

        <div class="section info">
            <h3>ğŸ“‹ è®¾ç½®æ­¥éª¤</h3>
            <div class="step" id="step1">
                <div class="step-number">1</div>
                <div>æ£€æŸ¥ Supabase é…ç½®å’Œè¿æ¥</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div>åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div>æ’å…¥åŸºç¡€æ•°æ®</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div>éªŒè¯æ•°æ®å®Œæ•´æ€§</div>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ”§ æ§åˆ¶é¢æ¿</h3>
            <button onclick="initializeSetup()">å¼€å§‹è®¾ç½®</button>
            <button onclick="checkTables()">æ£€æŸ¥è¡¨çŠ¶æ€</button>
            <button onclick="showCreateTablesSQL()">æ˜¾ç¤ºåˆ›å»ºè¡¨SQL</button>
            <button onclick="showInsertDataSQL()">æ˜¾ç¤ºæ’å…¥æ•°æ®SQL</button>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
        </div>

        <div class="section">
            <h3>ğŸ“ æ§åˆ¶å°è¾“å‡º</h3>
            <div id="console" class="console-output">ç­‰å¾…åˆå§‹åŒ–...</div>
        </div>

        <div class="section">
            <h3>ğŸ¯ SQL è¾“å‡º</h3>
            <div id="sql-output" style="display: none;">
                <h4>å¤åˆ¶ä»¥ä¸‹ SQL åˆ° Supabase SQL ç¼–è¾‘å™¨ä¸­è¿è¡Œï¼š</h4>
                <button onclick="copySQL()">å¤åˆ¶SQL</button>
                <div id="sql-content" class="sql-box"></div>
            </div>
        </div>

        <div class="section info">
            <h3>ğŸ”— å¿«é€Ÿé“¾æ¥</h3>
            <p><a href="https://supabase.com/dashboard/project/mttizdeqmqvpmnwqrfgw/sql/new" target="_blank">ğŸ“Š Supabase SQL ç¼–è¾‘å™¨</a></p>
            <p><a href="https://supabase.com/dashboard/project/mttizdeqmqvpmnwqrfgw" target="_blank">ğŸ›ï¸ Supabase æ§åˆ¶å°</a></p>
        </div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        let supabase = null;
        let consoleOutput = document.getElementById('console');
        let sqlOutput = document.getElementById('sql-output');
        let sqlContent = document.getElementById('sql-content');
        
        // æ§åˆ¶å°è¾“å‡ºå‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        function clearConsole() {
            consoleOutput.textContent = '';
        }
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }
        
        // åˆå§‹åŒ–è®¾ç½®
        async function initializeSetup() {
            clearConsole();
            log('å¼€å§‹æ•°æ®åº“è®¾ç½®æµç¨‹...');
            
            try {
                // æ£€æŸ¥é…ç½®
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    log('Supabase é…ç½®æœªæ‰¾åˆ°', 'error');
                    return;
                }
                
                log('é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ');
                updateStep(1, 'active');
                
                // åˆ›å»ºå®¢æˆ·ç«¯
                supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                log('Supabase å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
                
                // æ£€æŸ¥è¿æ¥
                const { data, error } = await supabase
                    .from('products')
                    .select('count', { count: 'exact', head: true });
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = relation not found
                    log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    return;
                }
                
                log('æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
                updateStep(1, 'completed');
                
                // æ£€æŸ¥è¡¨çŠ¶æ€
                await checkTables();
                
            } catch (error) {
                log(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ£€æŸ¥è¡¨çŠ¶æ€
        async function checkTables() {
            if (!supabase) {
                log('è¯·å…ˆåˆå§‹åŒ–è®¾ç½®', 'warning');
                return;
            }
            
            updateStep(2, 'active');
            log('æ£€æŸ¥æ•°æ®åº“è¡¨...');
            
            const tables = ['products', 'categories', 'users', 'orders', 'cart_items', 'order_items'];
            let allTablesExist = true;
            
            for (const table of tables) {
                try {
                    const { data, error, count } = await supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (error) {
                        log(`è¡¨ ${table}: ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®`, 'error');
                        allTablesExist = false;
                    } else {
                        log(`è¡¨ ${table}: å­˜åœ¨ (${count} æ¡è®°å½•)`, 'success');
                    }
                } catch (e) {
                    log(`è¡¨ ${table}: æ£€æŸ¥å¤±è´¥`, 'error');
                    allTablesExist = false;
                }
            }
            
            if (allTablesExist) {
                updateStep(2, 'completed');
                updateStep(3, 'active');
                log('æ‰€æœ‰è¡¨éƒ½å­˜åœ¨ï¼Œå¯ä»¥æ’å…¥æ•°æ®', 'success');
            } else {
                log('éœ€è¦åˆ›å»ºè¡¨', 'warning');
                showCreateTablesSQL();
            }
        }
        
        // æ˜¾ç¤ºåˆ›å»ºè¡¨SQL
        function showCreateTablesSQL() {
            const sql = `-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- äº§å“åˆ†ç±»è¡¨
CREATE TABLE IF NOT EXISTS categories (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    name varchar(255) NOT NULL,
    slug varchar(255) UNIQUE NOT NULL,
    description text,
    sort_order integer DEFAULT 0,
    is_active boolean DEFAULT true,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- äº§å“è¡¨
CREATE TABLE IF NOT EXISTS products (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    name varchar(255) NOT NULL,
    description text,
    price decimal(10,2) NOT NULL,
    original_price decimal(10,2),
    sku varchar(100) UNIQUE NOT NULL,
    category_id uuid REFERENCES categories(id),
    brand varchar(100),
    model varchar(100),
    color varchar(100),
    size varchar(100),
    weight decimal(8,2),
    stock_quantity integer DEFAULT 0,
    images jsonb DEFAULT '[]'::jsonb,
    tags text[] DEFAULT '{}',
    is_featured boolean DEFAULT false,
    is_active boolean DEFAULT true,
    rating decimal(3,2) DEFAULT 0,
    review_count integer DEFAULT 0,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- ç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS users (
    id uuid PRIMARY KEY,
    email varchar(255) UNIQUE NOT NULL,
    username varchar(100),
    first_name varchar(100),
    last_name varchar(100),
    phone varchar(20),
    avatar_url text,
    role varchar(50) DEFAULT 'customer',
    is_active boolean DEFAULT true,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- è´­ç‰©è½¦è¡¨
CREATE TABLE IF NOT EXISTS cart_items (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id uuid REFERENCES users(id) ON DELETE CASCADE,
    product_id uuid REFERENCES products(id) ON DELETE CASCADE,
    quantity integer NOT NULL DEFAULT 1,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    UNIQUE(user_id, product_id)
);

-- è®¢å•è¡¨
CREATE TABLE IF NOT EXISTS orders (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_number varchar(100) UNIQUE NOT NULL,
    user_id uuid REFERENCES users(id),
    status varchar(50) DEFAULT 'pending',
    total_amount decimal(10,2) NOT NULL,
    shipping_address jsonb,
    payment_method varchar(50),
    payment_status varchar(50) DEFAULT 'pending',
    notes text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- è®¢å•è¯¦æƒ…è¡¨
CREATE TABLE IF NOT EXISTS order_items (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_id uuid REFERENCES orders(id) ON DELETE CASCADE,
    product_id uuid REFERENCES products(id),
    product_name varchar(255) NOT NULL,
    product_price decimal(10,2) NOT NULL,
    quantity integer NOT NULL,
    subtotal decimal(10,2) NOT NULL,
    product_snapshot jsonb,
    created_at timestamptz DEFAULT now()
);`;

            sqlContent.textContent = sql;
            sqlOutput.style.display = 'block';
            log('åˆ›å»ºè¡¨SQLå·²ç”Ÿæˆï¼Œè¯·å¤åˆ¶åˆ°Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œ');
        }
        
        // æ˜¾ç¤ºæ’å…¥æ•°æ®SQL
        function showInsertDataSQL() {
            const sql = `-- æ’å…¥åˆ†ç±»æ•°æ®
INSERT INTO categories (name, slug, description, sort_order, is_active) VALUES
('æ•°ç ç”µå­', 'electronics', 'æ™ºèƒ½æ‰‹æœºã€å¹³æ¿ç”µè„‘ã€ç¬”è®°æœ¬ç”µè„‘ç­‰ç”µå­è®¾å¤‡', 1, true),
('æœè£…é…é¥°', 'clothing', 'æ—¶å°šæœè£…ã€é‹å¸½ã€ç®±åŒ…ç­‰é…é¥°ç”¨å“', 2, true),
('å®¶å±…ç”Ÿæ´»', 'home', 'å®¶å…·ã€å®¶çººã€å¨å…·ã€ç”Ÿæ´»ç”¨å“ç­‰', 3, true),
('ç¾å¦†æŠ¤è‚¤', 'beauty', 'æŠ¤è‚¤å“ã€å½©å¦†ã€ä¸ªäººæŠ¤ç†ç­‰ç¾å¦†äº§å“', 4, true),
('è¿åŠ¨æˆ·å¤–', 'sports', 'è¿åŠ¨è£…å¤‡ã€æˆ·å¤–ç”¨å“ã€å¥èº«å™¨æç­‰', 5, true)
ON CONFLICT (slug) DO NOTHING;

-- æ’å…¥äº§å“æ•°æ®
INSERT INTO products (name, description, price, original_price, sku, category_id, brand, stock_quantity, images, is_featured) VALUES
('iPhone 15 Pro', 'è‹¹æœæœ€æ–°æ——èˆ°æ‰‹æœº', 8999, 9999, 'IPHONE15', (SELECT id FROM categories WHERE slug = 'electronics'), 'Apple', 50, '[\"https://picsum.photos/400/400?random=1\"]'::jsonb, true),
('å°ç±³ç©ºæ°”å‡€åŒ–å™¨', 'é«˜æ•ˆé™¤ç”²é†›ç©ºæ°”å‡€åŒ–å™¨', 1299, 1599, 'MIAIR', (SELECT id FROM categories WHERE slug = 'home'), 'å°ç±³', 30, '[\"https://picsum.photos/400/400?random=2\"]'::jsonb, false),
('è¿åŠ¨Tæ¤', 'é€æ°”èˆ’é€‚è¿åŠ¨Tæ¤', 199, 299, 'SPORTSHIRT', (SELECT id FROM categories WHERE slug = 'clothing'), 'Nike', 100, '[\"https://picsum.photos/400/400?random=3\"]'::jsonb, false),
('åä¸ºå¹³æ¿', 'åä¸ºé«˜ç«¯å¹³æ¿ç”µè„‘', 3999, 4499, 'HWPAD', (SELECT id FROM categories WHERE slug = 'electronics'), 'åä¸º', 25, '[\"https://picsum.photos/400/400?random=4\"]'::jsonb, true),
('æŠ¤è‚¤å¥—è£…', 'å…¨å¥—æŠ¤è‚¤å¥—è£…', 599, 899, 'SKINCARE', (SELECT id FROM categories WHERE slug = 'beauty'), 'å…°è”»', 80, '[\"https://picsum.photos/400/400?random=5\"]'::jsonb, false)
ON CONFLICT (sku) DO NOTHING;`;

            sqlContent.textContent = sql;
            sqlOutput.style.display = 'block';
            log('æ’å…¥æ•°æ®SQLå·²ç”Ÿæˆï¼Œè¯·å¤åˆ¶åˆ°Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œ');
            updateStep(3, 'completed');
        }
        
        // å¤åˆ¶SQLåˆ°å‰ªè´´æ¿
        function copySQL() {
            navigator.clipboard.writeText(sqlContent.textContent).then(() => {
                log('SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                log('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            if (!supabase) {
                log('è¯·å…ˆåˆå§‹åŒ–è®¾ç½®', 'warning');
                return;
            }
            
            log('æµ‹è¯•æ•°æ®æŸ¥è¯¢...');
            
            try {
                // æŸ¥è¯¢äº§å“
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*, categories(name)')
                    .limit(5);
                
                if (productsError) {
                    log(`äº§å“æŸ¥è¯¢å¤±è´¥: ${productsError.message}`, 'error');
                } else {
                    log(`æˆåŠŸæŸ¥è¯¢åˆ° ${products.length} ä¸ªäº§å“`, 'success');
                    updateStep(4, 'completed');
                }
                
                // æŸ¥è¯¢åˆ†ç±»
                const { data: categories, error: categoriesError } = await supabase
                    .from('categories')
                    .select('*');
                
                if (categoriesError) {
                    log(`åˆ†ç±»æŸ¥è¯¢å¤±è´¥: ${categoriesError.message}`, 'error');
                } else {
                    log(`æˆåŠŸæŸ¥è¯¢åˆ° ${categories.length} ä¸ªåˆ†ç±»`, 'success');
                }
                
            } catch (error) {
                log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('æ•°æ®åº“è®¾ç½®å·¥å…·å·²åŠ è½½ï¼Œç‚¹å‡»"å¼€å§‹è®¾ç½®"æŒ‰é’®å¼€å§‹');
        });
    </script>
</body>
</html>